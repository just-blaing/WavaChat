<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WavaChat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f12;
            --box-bg: #18181b;
            --text: #e4e4e7;
            --text-dim: #a1a1aa;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --border: #27272a;
            --bubble-me: #4338ca;
            --bubble-other: #27272a;
            --input-bg: #09090b;
            --err: #ef4444;
            --quote-bg: rgba(0, 0, 0, 0.2);
            --date-bg: rgba(255, 255, 255, 0.05);
            --code-bg: rgba(0,0,0,0.3);
            --mention-bg: rgba(99, 102, 241, 0.4);
            --highlight: rgba(99, 102, 241, 0.25);
        }
        [data-theme="amoled"] { --bg: #000; --box-bg: #000; --border: #333; }
        [data-theme="light"] {
            --bg: #fafafa; --box-bg: #fff; --text: #18181b; --text-dim: #71717a;
            --accent: #0ea5e9; --border: #e4e4e7; --bubble-me: #0ea5e9; --bubble-other: #f4f4f5;
            --input-bg: #fff; --accent-glow: rgba(14, 165, 233, 0.2); --quote-bg: rgba(0, 0, 0, 0.05);
            --date-bg: rgba(0,0,0,0.05); --code-bg: rgba(0,0,0,0.06); --mention-bg: rgba(14, 165, 233, 0.2);
            --highlight: rgba(14, 165, 233, 0.2);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); margin: 0; font-family: 'JetBrains Mono', monospace; height: 100dvh; color: var(--text); overflow: hidden; transition: background 0.3s, color 0.3s; }
        #root { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        #auth-screen, #settings-screen, #profile-modal {
            position: absolute; inset: 0; z-index: 200;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg); transition: opacity 0.3s;
        }
        #settings-screen, #profile-modal { background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 150; display: none; opacity: 0; }
        .box {
            width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 12px;
            background: var(--box-bg); padding: 24px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); position: relative;
        }
        h2, h3 { text-align: center; margin: 0 0 10px 0; font-weight: 700; letter-spacing: -0.5px; }
        .error { color: var(--err); font-size: 12px; text-align: center; min-height: 16px; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 10px 14px; background: var(--input-bg);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); outline: none; font-family: inherit; font-size: 13px;
            transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
        button {
            width: 100%; padding: 10px; border: none; background: var(--accent);
            color: white; border-radius: 8px; cursor: pointer; font-family: inherit;
            font-weight: 700; transition: 0.2s; font-size: 13px; letter-spacing: 0.5px;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        button.sec { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        button.sec:hover { background: var(--border); color: var(--text); }
        button.danger { background: var(--err); }
        #header {
            padding: 0 20px; background: rgba(var(--box-bg), 0.8);
            border-bottom: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center; z-index: 50;
            backdrop-filter: blur(10px); height: 60px;
        }
        .header-info { display: flex; flex-direction: column; justify-content: center; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
        .header-info:hover { background: var(--border); }
        .header-title { font-weight: 700; font-size: 14px; }
        .header-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .icon-btn {
            background: transparent; padding: 8px; width: auto; color: var(--text-dim);
            display: flex; align-items: center; justify-content: center; border-radius: 6px;
        }
        .icon-btn:hover { background: var(--border); color: var(--text); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        #main-layout { flex: 1; display: flex; overflow: hidden; }
        #left-col { flex: 1; display: flex; flex-direction: column; position: relative; }
        #right-col {
            width: 280px; border-left: 1px solid var(--border); background: var(--box-bg);
            display: flex; flex-direction: column; padding: 20px; gap: 15px;
            overflow-y: hidden; z-index: 40; transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .chat-info-center {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            padding-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        .chat-big-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #9333ea);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; color: white; box-shadow: 0 10px 30px -10px var(--accent-glow);
        }
        .chat-title-big { font-size: 16px; font-weight: 800; }
        .chat-stats { font-size: 12px; color: var(--text-dim); }
        #participants-section { flex: 1; display: flex; flex-direction: column; min-height: 0; margin-top: 10px; }
        #participants-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; scrollbar-width: thin; }
        .part-item { display: flex; align-items: center; gap: 10px; padding: 6px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .part-item:hover { background: var(--border); }
        #chatbox {
            flex: 1; overflow-y: auto; padding: 15px 20px; display: flex;
            flex-direction: column; gap: 8px; scrollbar-width: thin; scrollbar-color: var(--border) transparent;
        }
        .msg-row { display: flex; width: 100%; gap: 10px; align-items: flex-end; }
        .msg-row.me { justify-content: flex-end; }
        .date-divider {
            align-self: center; background: var(--date-bg); color: var(--text-dim);
            padding: 4px 12px; border-radius: 12px; font-size: 10px; margin: 10px 0;
            font-weight: bold;
        }
        .avatar-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: var(--border); cursor: pointer; }
        .avatar-stub {
            width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 12px; color: white; text-transform: uppercase; cursor: pointer;
        }
        .avatar-stub:hover, .avatar-img:hover { filter: brightness(0.8); }
        .bubble {
            max-width: 80%; padding: 8px 12px; border-radius: 14px; font-size: 14px;
            line-height: 1.4; word-wrap: break-word; display: flex; flex-direction: column;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
            transition: transform 0.1s, background-color 0.5s;
        }
        .me .bubble { background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .other .bubble { background: var(--bubble-other); color: var(--text); border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        @keyframes highlight-anim {
            0% { box-shadow: 0 0 0 2px var(--accent); background: var(--highlight); }
            100% { box-shadow: 0 0 0 0 transparent; }
        }
        .bubble.highlighted { animation: highlight-anim 1.5s ease-out; }
        .msg-actions {
            position: absolute; top: -30px; right: 0;
            background: var(--box-bg); border: 1px solid var(--border);
            border-radius: 8px; padding: 4px; display: flex; gap: 4px;
            opacity: 0; transform: translateY(5px); pointer-events: none;
            transition: 0.1s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 20;
        }
        .bubble:hover .msg-actions, .bubble.tapped .msg-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .action-btn {
            width: 24px; height: 24px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-dim);
        }
        .action-btn:hover { background: var(--border); color: var(--accent); }
        .action-btn.del:hover { color: var(--err); }
        .action-btn svg { width: 14px; height: 14px; fill: currentColor; }
        .sender { font-size: 11px; font-weight: 800; margin-bottom: 2px; color: var(--accent); opacity: 0.9; cursor: pointer; }
        .sender:hover { text-decoration: underline; }
        .me .sender { display: block; color: rgba(255,255,255,0.8); text-align: right; cursor: default; }
        .me .sender:hover { text-decoration: none; }
        .time { font-size: 9px; align-self: flex-end; margin-left: 6px; opacity: 0.6; margin-top: 2px; }
        .quote-box {
            background: var(--quote-bg); border-left: 2px solid var(--accent);
            padding: 4px 8px; border-radius: 4px; margin-bottom: 4px;
            font-size: 11px; opacity: 0.9; cursor: pointer; position: relative;
        }
        .quote-nick { font-weight: bold; color: var(--accent); margin-bottom: 1px; display: block; }
        .quote-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 200px; }
        b { font-weight: 800; }
        i { font-style: italic; opacity: 0.9; }
        s { text-decoration: line-through; opacity: 0.7; }
        code { font-family: 'JetBrains Mono', monospace; background: var(--code-bg); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }
        pre { margin: 6px 0; padding: 8px; background: var(--code-bg); border-radius: 6px; overflow-x: auto; font-size: 12px; }
        pre code { background: transparent; padding: 0; white-space: pre-wrap; word-wrap: break-word; }
        .mention { background: var(--mention-bg); padding: 0 4px; border-radius: 4px; color: var(--accent); font-weight: bold; cursor: pointer; }
        .me .mention { color: white; background: rgba(255,255,255,0.2); }
        .media-content { display: block; border-radius: 6px; margin-top: 6px; }
        img.media-content, video.media-content {
            width: 100%; min-width: 200px; max-width: 400px; height: auto;
            object-fit: contain; cursor: zoom-in; background: rgba(0,0,0,0.1);
        }
        audio.media-content { width: 100%; min-width: 240px; height: 36px; margin-top: 5px; }
        #reply-bar {
            display: none; padding: 8px 16px; background: var(--box-bg);
            border-top: 1px solid var(--border); align-items: center; justify-content: space-between;
        }
        #reply-preview { font-size: 12px; overflow: hidden; }
        #input-area {
            padding: 12px; background: var(--bg); border-top: 1px solid var(--border);
            display: flex; gap: 8px; align-items: flex-end; z-index: 50; position: relative;
        }
        .input-wrapper { flex: 1; position: relative; }
        #msg-input { resize: none; height: 40px; min-height: 40px; max-height: 120px; padding-right: 10px; overflow-y: hidden; }
        #file-input { display: none; }
        .attach-btn {
            width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background: var(--box-bg); border: 1px solid var(--border); color: var(--text-dim);
        }
        .attach-btn:hover { color: var(--accent); border-color: var(--accent); }
        #send-btn { width: auto; height: 40px; padding: 0 16px; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; gap: 6px; }
        .close-x {
            position: absolute; top: 15px; right: 15px; background: transparent; border: none;
            color: var(--text-dim); font-size: 20px; cursor: pointer; padding: 0; width: auto;
        }
        .close-x:hover { color: var(--err); }
        .avatar-picker {
            width: 80px; height: 80px; border-radius: 50%; background: var(--border);
            margin: 0 auto; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; border: 2px dashed var(--text-dim);
            transition: border-color 0.2s;
        }
        .avatar-picker:hover { border-color: var(--accent); }
        .avatar-picker img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-picker span { font-size: 10px; color: var(--text-dim); text-align: center; }
        #my-input-avatar {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0;
            background: var(--border); display: block;
        }
        #autocomplete-list {
            position: absolute; bottom: 100%; left: 0; width: 250px; background: var(--box-bg);
            border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; flex-direction: column; max-height: 200px; overflow-y: auto; z-index: 100;
        }
        .ac-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .ac-item:hover { background: var(--border); }
        .ac-item img { width: 20px; height: 20px; border-radius: 50%; }
        .ac-item .stub { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; }
        .profile-content { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .p-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background: var(--border); margin-bottom: 5px; }
        .p-stub { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; margin-bottom: 5px; }
        .p-nick { font-size: 20px; font-weight: 800; }
        .p-username { font-size: 14px; color: var(--text-dim); font-family: monospace; }
        .p-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: var(--border); margin-top: -5px; }
        .p-bio { text-align: center; font-size: 13px; font-style: italic; color: var(--text-dim); margin: 10px 0; max-width: 100%; word-break: break-word; }
        .p-id { font-size: 10px; color: var(--text-dim); font-family: monospace; padding-top: 10px; width: 100%; text-align: center; }
        @media (max-width: 800px) {
            #right-col {
                position: fixed; top: 60px; left: 0; width: 100%; height: calc(100% - 60px);
                z-index: 100; border-left: none; transform: translateX(100%);
            }
            #right-col.open { transform: translateX(0); }
            .bubble { max-width: 90%; }
            img.media-content, video.media-content { min-width: 100%; max-width: 100%; }
            .box { max-width: 100%; border-radius: 0; border: none; height: 100%; justify-content: center; }
            .msg-actions { top: -35px; right: 0; }
            #input-area { padding: 8px; gap: 6px; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
            #msg-input { font-size: 16px; } /* prevent ios zoom */
            .attach-btn { width: 36px; height: 36px; }
            #send-btn { width: 44px; padding: 0; justify-content: center; }
            #send-btn span { display: none; } /* hide text if any */
            #send-btn svg { margin: 0; width: 20px; }
        }
    </style>
</head>
<body onclick="resume_audio()">
<div id="root">
    <div id="auth-screen">
        <div class="box">
            <h2 style="color: var(--accent)">WavaChat v0.3</h2>
            <div id="err-msg" class="error"></div>
            <div class="avatar-picker" onclick="document.getElementById('reg-avatar-input').click()">
                <img id="reg-avatar-prev" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=">
                <span id="reg-avatar-txt">фото (необязательно)</span>
            </div>
            <input type="file" id="reg-avatar-input" style="display:none" accept="image/*" onchange="preview_avatar(this, 'reg-avatar-prev', 'reg-avatar-txt')">
            <input type="text" id="a-nick" placeholder="никнейм" autocomplete="off">
            <input type="text" id="a-username" placeholder="юзернейм (3-16 символов, англ)" autocomplete="off" style="display:none">
            <input type="password" id="a-pass" placeholder="пароль (от 8 символов)">
            <button id="auth-main-btn" onclick="api_auth('login')">войти</button>
            <button class="sec" id="auth-toggle-btn" onclick="toggle_auth_mode()">нет аккаунта? регайся</button>
        </div>
    </div>
    <div id="settings-screen" onclick="close_modal('settings-screen')">
        <div class="box" onclick="event.stopPropagation()">
            <button class="close-x" onclick="close_modal('settings-screen')">×</button>
            <h3>настройки</h3>
            <div style="text-align:center; margin-bottom: 10px;">
                <div class="avatar-picker" onclick="document.getElementById('set-avatar-input').click()" style="width: 70px; height: 70px;">
                    <img id="set-avatar-prev" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=">
                    <span id="set-avatar-txt">изменить</span>
                </div>
                <input type="file" id="set-avatar-input" style="display:none" accept="image/*" onchange="upload_new_avatar(this)">
            </div>
            <input type="text" id="set-bio" placeholder="о себе..." maxlength="100">
            <button class="sec" onclick="update_bio()">сохранить био</button>
            <label style="font-size: 12px; color: var(--text-dim); margin-top: 10px;">тема</label>
            <select id="theme-select" onchange="change_theme()">
                <option value="dark">темная</option>
                <option value="amoled">amoled</option>
                <option value="light">светлая</option>
            </select>
            <button class="danger" onclick="do_logout()" style="margin-top: 10px;">выйти</button>
        </div>
    </div>
    <div id="profile-modal" onclick="close_modal('profile-modal')">
        <div class="box" onclick="event.stopPropagation()">
            <button class="close-x" onclick="close_modal('profile-modal')">×</button>
            <div class="profile-content" id="p-content"></div>
        </div>
    </div>
    <div id="main-layout">
        <div id="left-col">
            <div id="header">
                <div class="header-info" onclick="toggle_info()">
                    <span id="head-title" class="header-title">общий чат</span>
                    <span id="head-sub" class="header-sub">загрузка...</span>
                </div>
                <button class="icon-btn" onclick="open_modal('settings-screen')">
                    <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65A.488.488 0 0 0 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.63c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.63c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.63z"/></svg>
                </button>
            </div>
            <div id="chatbox">
                <div id="top-loader" style="text-align: center; font-size: 11px; color: var(--accent); display: none; margin-bottom: 10px; opacity: 0.7;">загружаю соо...</div>
                <div id="msg-container" style="display: flex; flex-direction: column; gap: 6px; padding-bottom: 10px;"></div>
            </div>
            <div id="reply-bar">
                <div id="reply-preview"></div>
                <button class="icon-btn" onclick="cancel_reply()" style="padding: 4px;">
                    <svg viewBox="0 0 24 24" style="width: 18px;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div id="input-area">
                <img id="my-input-avatar" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="display:none">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">
                    <svg viewBox="0 0 24 24" style="width: 20px;"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </button>
                <div class="input-wrapper">
                    <div id="autocomplete-list"></div>
                    <textarea id="msg-input" placeholder="сообщение..." oninput="auto_grow(this); check_autocomplete(this)"></textarea>
                </div>
                <button id="send-btn" onclick="send()">
                    <svg viewBox="0 0 24 24" style="width: 16px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
                <input type="file" id="file-input" onchange="upload_file(this)">
            </div>
        </div>
        <div id="right-col">
            <div class="chat-info-center">
                <div class="chat-big-avatar">#</div>
                <div class="chat-title-big">общий чат</div>
                <div id="right-stats" class="chat-stats">...</div>
            </div>
            <div id="participants-section">
                <span class="info-label" style="margin-bottom: 6px; color: var(--text-dim); font-size: 11px; text-transform: uppercase;">участники</span>
                <div id="participants-list"></div>
            </div>
        </div>
    </div>
</div>
<script>
    const api_url = 'http://tcp.cloudpub.ru:31804/api'
    const ws_base = 'ws://tcp.cloudpub.ru:31804'
    const crypt_key = "|cCeXXLJqyr~KQSx8~LFzZCabs%EW11dB6$Nego~~}e~8}7Xy~@~Vz4ExVMB"
    let ws
    let current_user = localStorage.getItem('chat_nick')
    let current_username = localStorage.getItem('chat_username')
    let current_token = localStorage.getItem('chat_token')
    let current_id = parseInt(localStorage.getItem('chat_uid') || 0)
    let is_reg_mode = false
    let pending_reg_avatar = ''
    let oldest_id = null
    let is_loading = false
    let all_loaded = false
    let integrity_ok = false
    let last_render_date = null
    let reply_target = null
    let all_participants = []
    const audio_ctx = new (window.AudioContext || window.webkitAudioContext)()
    let audio_ready = false
    let cfg_theme = localStorage.getItem('chat_theme') || 'dark'
    document.body.setAttribute('data-theme', cfg_theme)
    document.getElementById('theme-select').value = cfg_theme
    if (current_token) start_app()
    function resume_audio() {
        if (!audio_ready && audio_ctx.state !== 'running') {
            audio_ctx.resume().then(() => audio_ready = true)
        }
    }
    function toggle_info() {
        if (window.innerWidth <= 800) {
            document.getElementById('right-col').classList.toggle('open')
        }
    }
    function play_ping() {
        try {
            const osc = audio_ctx.createOscillator()
            const gain = audio_ctx.createGain()
            osc.connect(gain)
            gain.connect(audio_ctx.destination)
            osc.frequency.value = 440
            gain.gain.value = 0.1
            osc.start()
            gain.gain.exponentialRampToValueAtTime(0.00001, audio_ctx.currentTime + 0.5)
            osc.stop(audio_ctx.currentTime + 0.5)
        } catch(e) {}
    }
    function toggle_auth_mode() {
        is_reg_mode = !is_reg_mode
        document.getElementById('a-username').style.display = is_reg_mode ? 'block' : 'none'
        document.getElementById('auth-main-btn').innerText = is_reg_mode ? 'зарегистрироваться' : 'войти'
        document.getElementById('auth-toggle-btn').innerText = is_reg_mode ? 'есть аккаунт? войти' : 'нет аккаунта? регайся'
        document.getElementById('auth-main-btn').onclick = () => api_auth(is_reg_mode ? 'reg' : 'login')
    }
    function djb2(str) {
        let hash = 5381
        for (let i = 0; i < str.length; i++) hash = ((hash << 5) + hash) + str.charCodeAt(i)
        return hash
    }
    function gen_color(nick) { return `hsl(${Math.abs(djb2(nick)) % 360}, 65%, 50%)` }
    function get_avatar_html(nick, avatar_data, uid) {
        const click_attr = uid ? `onclick="load_profile_in_modal(${uid}); event.stopPropagation()"` : ''
        if (avatar_data && avatar_data.startsWith('data:image/') && avatar_data.length > 20) {
            return `<img src="${avatar_data}" class="avatar-img" ${click_attr}>`
        }
        const letter = nick ? nick[0] : '?'
        return `<div class="avatar-stub" style="background: ${gen_color(nick || 'anon')}" ${click_attr}>${letter}</div>`
    }
    function update_input_avatar() {
        const av = localStorage.getItem('chat_avatar')
        const img = document.getElementById('my-input-avatar')
        if (av && av.startsWith('data:image/') && av.length > 20) {
            img.src = av; img.style.display = 'block'
        } else {
            img.style.display = 'none'
        }
    }
    function format_text(txt) {
        let safe = txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        safe = safe.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        safe = safe.replace(/`([^`]+)`/g, '<code>$1</code>')
        safe = safe.replace(/@([a-zA-Z0-9_*()]+)/g, '<span class="mention" onclick="open_profile_by_username(\'$1\')">@$1</span>')
        safe = safe.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        safe = safe.replace(/__(.*?)__/g, '<i>$1</i>')
        safe = safe.replace(/~~(.*?)~~/g, '<s>$1</s>')
        return safe
    }
    function process_image(file, cb) {
        const reader = new FileReader()
        reader.onload = (e) => {
            const img = new Image()
            img.src = e.target.result
            img.onload = () => {
                const canvas = document.createElement('canvas')
                const ctx = canvas.getContext('2d')
                const size = 128
                canvas.width = size; canvas.height = size
                const min = Math.min(img.width, img.height)
                ctx.drawImage(img, (img.width-min)/2, (img.height-min)/2, min, min, 0, 0, size, size)
                cb(canvas.toDataURL('image/jpeg', 0.8))
            }
        }
        reader.readAsDataURL(file)
    }
    function preview_avatar(inp, img_id, txt_id) {
        if (inp.files && inp.files[0]) {
            process_image(inp.files[0], (base64) => {
                if (img_id === 'reg-avatar-prev') pending_reg_avatar = base64
                const img = document.getElementById(img_id)
                img.src = base64
                img.style.display = 'block'
                if(txt_id) document.getElementById(txt_id).style.display = 'none'
            })
        }
    }
    async function api_auth(endpoint) {
        const n = document.getElementById('a-nick').value.trim()
        const p = document.getElementById('a-pass').value.trim()
        const u = document.getElementById('a-username').value.trim()
        const payload = endpoint === 'reg'
            ? { nick: n, pass: p, username: u, avatar: pending_reg_avatar }
            : { login: n, pass: p }
        try {
            const res = await fetch(`${api_url}/${endpoint}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            const d = await res.json()
            if (d.ok) {
                current_user = d.user
                current_username = d.username
                current_token = d.token
                current_id = d.id
                localStorage.setItem('chat_nick', current_user)
                localStorage.setItem('chat_username', current_username)
                localStorage.setItem('chat_token', current_token)
                localStorage.setItem('chat_uid', current_id)
                if(d.avatar) localStorage.setItem('chat_avatar', d.avatar)
                else localStorage.removeItem('chat_avatar')
                start_app()
            } else { document.getElementById('err-msg').innerText = `err: ${d.err}` }
        } catch (err) { document.getElementById('err-msg').innerText = 'offline' }
    }
    function start_app() {
        document.getElementById('auth-screen').style.opacity = 0
        setTimeout(() => document.getElementById('auth-screen').style.display = 'none', 300)
        update_input_avatar()
        connect_ws()
        load_participants()
        document.getElementById('chatbox').addEventListener('scroll', () => {
            if (document.getElementById('chatbox').scrollTop === 0 && !is_loading && !all_loaded) load_history(oldest_id)
        })
    }
    async function load_participants() {
        try {
            const r = await fetch(`${api_url}/participants`)
            all_participants = await r.json()
            all_participants.sort((a, b) => a.nick.toLowerCase().localeCompare(b.nick.toLowerCase()))
            const list = document.getElementById('participants-list')
            list.innerHTML = ''
            all_participants.forEach(u => {
                const row = document.createElement('div')
                row.className = 'part-item'
                row.onclick = () => {
                    load_profile_in_modal(u.id);
                    if(window.innerWidth <= 800) document.getElementById('right-col').classList.remove('open')
                }
                const av = document.createElement('div')
                av.innerHTML = get_avatar_html(u.nick, u.avatar)
                if(av.firstChild.classList.contains('avatar-img')) {
                    av.firstChild.style.width = '24px'; av.firstChild.style.height = '24px'; av.firstChild.style.cursor = 'pointer'
                } else {
                    av.firstChild.style.width = '24px'; av.firstChild.style.height = '24px'; av.firstChild.style.fontSize = '10px'; av.firstChild.style.cursor = 'pointer'
                }
                const name = document.createElement('span')
                name.innerText = u.nick
                row.appendChild(av.firstChild)
                row.appendChild(name)
                list.appendChild(row)
            })
        } catch(e) {}
    }
    async function load_profile_in_modal(uid) {
        if (!uid) return
        try {
            const r = await fetch(`${api_url}/user/${uid}`)
            const u = await r.json()
            if (!u.id) return
            open_modal('profile-modal')
            const c = document.getElementById('p-content')
            let status_html = ''
            if (u.is_online) {
                status_html = '<span class="p-status" style="color: #4ade80">в сети</span>'
            } else {
                if (!u.last_seen || u.last_seen < 100000) {
                     status_html = `<span class="p-status" style="color: var(--text-dim)">был(а) давно</span>`
                } else {
                    const d = new Date(u.last_seen)
                    const t = d.toLocaleDateString() === new Date().toLocaleDateString()
                        ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                        : d.toLocaleDateString()
                    status_html = `<span class="p-status" style="color: var(--text-dim)">был(а) ${t}</span>`
                }
            }
            let av_html = ''
            if (u.avatar && u.avatar.startsWith('data:image/') && u.avatar.length > 20) av_html = `<img src="${u.avatar}" class="p-avatar">`
            else av_html = `<div class="p-stub" style="background:${gen_color(u.nick)}">${u.nick[0]}</div>`
            let uname_html = u.username ? `<div class="p-username">@${u.username}</div>` : ''
            let bio_html = u.bio ? `<div class="p-bio">${format_text(u.bio)}</div>` : ''
            c.innerHTML = `
                ${av_html}
                <div class="p-nick">${u.nick}</div>
                ${uname_html}
                ${status_html}
                ${bio_html}
                <div class="p-id">ID: ${u.id}</div>
            `
        } catch(e) {}
    }
    function open_profile_by_username(uname) {
        const u = all_participants.find(x => x.username === uname)
        if (u) load_profile_in_modal(u.id)
        else alert('user not found')
    }
    function check_autocomplete(textarea) {
        const val = textarea.value
        const cursor = textarea.selectionStart
        const text_before = val.substring(0, cursor)
        const match = text_before.match(/@([a-zA-Z0-9_*()]*)$/)
        const list = document.getElementById('autocomplete-list')
        if (match) {
            const query = match[1].toLowerCase()
            const filtered = all_participants.filter(u => u.username.toLowerCase().includes(query))
            if (filtered.length > 0) {
                list.style.display = 'flex'
                list.innerHTML = ''
                filtered.forEach(u => {
                    const item = document.createElement('div')
                    item.className = 'ac-item'
                    let av = ''
                    if (u.avatar && u.avatar.startsWith('data:image/') && u.avatar.length > 20) av = `<img src="${u.avatar}">`
                    else av = `<div class="stub" style="background:${gen_color(u.nick)}">${u.nick[0]}</div>`
                    item.innerHTML = `${av}<span>@${u.username}</span>`
                    item.onclick = () => {
                        const after = val.substring(cursor)
                        const completed = text_before.substring(0, match.index) + '@' + u.username + ' '
                        textarea.value = completed + after
                        textarea.focus()
                        list.style.display = 'none'
                    }
                    list.appendChild(item)
                })
            } else list.style.display = 'none'
        } else list.style.display = 'none'
    }
    async function load_history(before_id = null) {
        if (!integrity_ok) return
        is_loading = true
        if (before_id) document.getElementById('top-loader').style.display = 'block'
        let url = before_id ? `${api_url}/history?before=${before_id}` : `${api_url}/history`
        try {
            const r = await fetch(url, { headers: { 'x-chat-token': current_token } })
            if (r.status === 401) { do_logout(); return }
            const msgs = await r.json()
            if (msgs.length === 0) {
                all_loaded = true; document.getElementById('top-loader').style.display = 'none'; is_loading = false; return
            }
            if (msgs.length > 0) oldest_id = msgs[0].id
            const container = document.getElementById('msg-container')
            const old_h = container.scrollHeight
            const frag = document.createDocumentFragment()
            let prev_date_str = null
            let first_existing_date = null
            if (before_id && container.firstElementChild && container.firstElementChild.classList.contains('date-divider')) {
                first_existing_date = container.firstElementChild.innerText
            }
            msgs.forEach((m, idx) => {
                const d_obj = new Date(m.created_at || m.ts)
                const d_str = d_obj.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })
                if (d_str !== prev_date_str) {
                    const sep = document.createElement('div')
                    sep.className = 'date-divider'
                    sep.innerText = d_str
                    frag.appendChild(sep)
                    prev_date_str = d_str
                }
                frag.appendChild(create_msg_el(m))
            })
            if (before_id) {
                if (first_existing_date && prev_date_str === first_existing_date) {
                    container.removeChild(container.firstElementChild)
                }
                container.insertBefore(frag, container.firstChild)
                document.getElementById('chatbox').scrollTop = container.scrollHeight - old_h
            } else {
                container.innerHTML = ''
                container.appendChild(frag)
                document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight
                const last = msgs[msgs.length-1]
                if(last) last_render_date = new Date(last.created_at).toDateString()
            }
        } catch (e) {}
        finally { is_loading = false; document.getElementById('top-loader').style.display = 'none' }
    }
    function connect_ws() {
        ws = new WebSocket(`${ws_base}?token=${current_token}`)
        ws.onopen = () => {
            document.getElementById('head-title').innerText = 'соединение...'
            let url = window.location.href
            if (!url.startsWith('http')) url = api_url.replace('/api', '/index.html')
            fetch(url.split('?')[0]).then(r=>r.text()).then(txt => {
                const hash = CryptoJS.SHA256(txt.replace(/\r\n/g, '\n')).toString(CryptoJS.enc.Hex)
                ws.send(JSON.stringify({ type: 'integrity', hash }))
            }).catch(() => {})
        }
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data)
            if (data.type === 'sys' && data.txt === 'integrity_ok') {
                integrity_ok = true
                document.getElementById('head-title').innerText = 'общий чат'
                load_history()
            }
            if (data.type === 'meta') {
                document.getElementById('head-sub').innerText = `${data.total} участников, ${data.online} в сети`
                document.getElementById('right-stats').innerText = `${data.total} участников, ${data.online} в сети`
                return
            }
            if (data.type === 'del_msg') {
                const el = document.querySelector(`[data-id="${data.id}"]`)
                if (el) el.remove()
                return
            }
            if (!integrity_ok) return
            const d = new Date(data.created_at || data.ts)
            if (d.toDateString() !== last_render_date) {
                const sep = document.createElement('div')
                sep.className = 'date-divider'
                sep.innerText = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })
                document.getElementById('msg-container').appendChild(sep)
                last_render_date = d.toDateString()
            }
            document.getElementById('msg-container').appendChild(create_msg_el(data))
            const box = document.getElementById('chatbox')
            if (box.scrollHeight - box.scrollTop - box.clientHeight < 300) box.scrollTop = box.scrollHeight
        }
        ws.onclose = () => setTimeout(connect_ws, 3000)
    }
    function create_msg_el(data) {
        const is_me = data.uid === current_id
        let raw_txt = data.txt || data.t
        let plain = ''
        try { plain = CryptoJS.AES.decrypt(raw_txt, crypt_key).toString(CryptoJS.enc.Utf8) || '[err]' } catch(e) { plain = '[err]' }
        if (!is_me && plain.includes(`@${current_username}`)) {
             play_ping()
             if (Notification.permission === "granted") new Notification('WavaChat', { body: `${data.nick}: ${plain}` })
        }
        const row = document.createElement('div')
        row.className = 'msg-row ' + (is_me ? 'me' : 'other')
        row.dataset.id = data.id
        const av_div = document.createElement('div')
        av_div.innerHTML = get_avatar_html(data.nick, data.avatar, data.uid)
        if (!is_me) row.appendChild(av_div.firstChild)
        const b = document.createElement('div')
        b.className = 'bubble'
        b.onclick = (e) => {
            if (e.target.tagName!=='A' && e.target.tagName!=='IMG' && !e.target.classList.contains('mention')) {
                b.classList.toggle('tapped')
            }
        }
        const actions = document.createElement('div')
        actions.className = 'msg-actions'
        const rep_btn = document.createElement('div')
        rep_btn.className = 'action-btn'
        rep_btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>'
        rep_btn.onclick = (e) => {
            e.stopPropagation(); b.classList.remove('tapped')
            reply_target = { id: data.id, nick: data.nick, txt: plain }
            document.getElementById('reply-bar').style.display = 'flex'
            document.getElementById('reply-preview').innerHTML = `<span class="quote-nick">${data.nick}</span><span class="quote-text">${format_text(plain.substring(0,50))}</span>`
            document.getElementById('msg-input').focus()
        }
        actions.appendChild(rep_btn)
        if (is_me) {
            const del_btn = document.createElement('div')
            del_btn.className = 'action-btn del'
            del_btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>'
            del_btn.onclick = async (e) => {
                e.stopPropagation(); b.classList.remove('tapped')
                if(confirm('удалить?')) {
                   await fetch(`${api_url}/msg/delete`, {
                       method: 'POST',
                       headers: {'Content-Type': 'application/json', 'x-chat-token': current_token},
                       body: JSON.stringify({id: data.id})
                   })
                }
            }
            actions.appendChild(del_btn)
        }
        b.appendChild(actions)
        if (data.reply_id) {
            const q = document.createElement('div')
            q.className = 'quote-box'
            q.innerHTML = `<span class="quote-nick">${data.reply_nick||'???'}</span><span class="quote-text">${format_text(data.reply_txt||'')}</span>`
            q.onclick = (e) => {
                e.stopPropagation();
                const target_el = document.querySelector(`[data-id="${data.reply_id}"]`)
                if (target_el) {
                    target_el.scrollIntoView({behavior:'smooth', block:'center'})
                    const bub = target_el.querySelector('.bubble')
                    if (bub) {
                        bub.classList.remove('highlighted')
                        void bub.offsetWidth
                        bub.classList.add('highlighted')
                    }
                }
            }
            b.appendChild(q)
        }
        const s = document.createElement('span')
        s.className = 'sender'
        s.innerText = data.nick
        s.onclick = (e) => { e.stopPropagation(); load_profile_in_modal(data.uid) }
        b.appendChild(s)
        if (plain.startsWith('__MEDIA__:')) {
            try {
                const meta = JSON.parse(plain.split('__MEDIA__:')[1])
                if (meta.type.startsWith('image/')) {
                    const img = document.createElement('img')
                    img.src = meta.data; img.className = 'media-content'
                    img.onload = () => { if(document.getElementById('autoscroll-check')?.checked) document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight }
                    b.appendChild(img)
                } else if (meta.type.startsWith('video/')) {
                    const vid = document.createElement('video')
                    vid.src = meta.data; vid.controls = true; vid.className = 'media-content'; b.appendChild(vid)
                } else {
                    const link = document.createElement('a')
                    link.href = meta.data; link.download = meta.name
                    link.innerText = '>> file: ' + (meta.name||'file'); link.style.display='block'; link.style.marginTop='5px'; link.style.color='inherit'
                    b.appendChild(link)
                }
            } catch(e) {}
        } else {
            const t = document.createElement('span')
            t.innerHTML = format_text(plain)
            b.appendChild(t)
        }
        const time = document.createElement('span')
        time.className = 'time'
        time.innerText = new Date(data.created_at || data.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        b.appendChild(time)
        row.appendChild(b)
        if (is_me) {
            const av_me = document.createElement('div')
            av_me.innerHTML = get_avatar_html(data.nick, data.avatar, data.uid)
            row.appendChild(av_me.firstChild)
        }
        return row
    }
    function send() {
        const inp = document.getElementById('msg-input')
        const val = inp.value.trim()
        if (val && ws && ws.readyState === 1) {
            const enc = CryptoJS.AES.encrypt(val, crypt_key).toString()
            const payload = { t: enc }
            if (reply_target) {
                payload.reply_id = reply_target.id; payload.reply_nick = reply_target.nick
                payload.reply_txt = reply_target.txt.startsWith('__MEDIA__') ? '[media]' : reply_target.txt.substring(0,100)
            }
            ws.send(JSON.stringify(payload))
            inp.value = ''; inp.style.height = '40px'; cancel_reply(); document.getElementById('autocomplete-list').style.display='none'
        }
    }
    function update_bio() {
        const bio = document.getElementById('set-bio').value
        fetch(`${api_url}/me/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'x-chat-token': current_token},
            body: JSON.stringify({ bio })
        }).then(() => alert('био сохранено'))
    }
    function upload_new_avatar(inp) {
        if (inp.files && inp.files[0]) process_image(inp.files[0], (b64) => {
            document.getElementById('set-avatar-prev').src = b64
            document.getElementById('set-avatar-prev').style.display = 'block'
            document.getElementById('set-avatar-txt').style.display = 'none'
            fetch(`${api_url}/me/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'x-chat-token': current_token},
                body: JSON.stringify({ avatar: b64 })
            }).then(() => {
                localStorage.setItem('chat_avatar', b64)
                update_input_avatar()
                load_participants()
            })
        })
    }
    function upload_file(input) {
        const file = input.files[0]
        if (!file || file.size > 2*1024*1024) return
        const reader = new FileReader()
        reader.onload = (e) => {
            const payload = JSON.stringify({ data: e.target.result, type: file.type, name: file.name })
            const enc = CryptoJS.AES.encrypt(`__MEDIA__:${payload}`, crypt_key).toString()
            ws.send(JSON.stringify({ t: enc }))
        }
        reader.readAsDataURL(file)
        input.value = ''
    }
    function open_modal(id) {
        const s = document.getElementById(id)
        s.style.display = 'flex'
        if(id === 'settings-screen') {
            const av = localStorage.getItem('chat_avatar')
            if(av && av.startsWith('data:image/')) { document.getElementById('set-avatar-prev').src=av; document.getElementById('set-avatar-prev').style.display='block'; document.getElementById('set-avatar-txt').style.display='none'}
        }
        setTimeout(() => s.style.opacity = 1, 10)
    }
    function close_modal(id) {
        const s = document.getElementById(id)
        s.style.opacity = 0
        setTimeout(() => s.style.display = 'none', 200)
    }
    function cancel_reply() { reply_target = null; document.getElementById('reply-bar').style.display = 'none' }
    function auto_grow(element) { element.style.height = '40px'; element.style.height = (element.scrollHeight) + 'px' }
    function change_theme() { cfg_theme = document.getElementById('theme-select').value; localStorage.setItem('chat_theme', cfg_theme); document.body.setAttribute('data-theme', cfg_theme) }
    function do_logout() { localStorage.clear(); location.reload() }
    document.getElementById('msg-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send() } })
    if (Notification.permission === "default") Notification.requestPermission();
</script>
</body>
</html>
